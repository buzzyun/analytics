<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="org.fastcatgroup.analytics.db.mapper.SearchTypeRatioMapper">

	<update id="createTable" parameterType="map" >
		create table ${site}_${category}_${stype} (
			timeid varchar(11),
			dtype varchar(128),
			hit int,
			primary key (timeid, dtype)
		)
	</update>
	
	<update id="createIndex" parameterType="map" >
		create index typeid_${site}_${category}_${stype} on ${site}_${category}_${stype}(dtype)
	</update>
	
	<select id="validateTable" parameterType="map" resultType="map">
		select timeid, dtype, hit
		from ${site}_${category}_${stype}
		<if test="'${DBMS}' == 'mysql'"> limit 1</if>
		<if test="'${DBMS}' == ''"> fetch first 1 rows only </if>
	</select>

	<update id="dropTable" parameterType="map">
		drop table ${site}_${category}_${stype}
	</update>

	<select id="getEntry" parameterType="map" resultType="org.fastcatgroup.analytics.db.vo.SearchTypeRatioVO">
		select * from ${site}_${category}_${stype} where timeId=#{timeId} and dtype=#{dtype}
	</select>
	
	<select id="getMinEntry" parameterType="map" resultType="org.fastcatgroup.analytics.db.vo.SearchTypeRatioVO">
		select * from ${site}_${category}_${stype} where 
		timeId=(
			select min(timeId) from ${site}_${category}_${stype} where timeId like '${dFilter}%'
			<if test="dtype !=null and dtype !=''">
			and dtype=#{dtype}
			</if>
		) 
		<if test="'${DBMS}' == 'mysql'"> limit 1</if>
		<if test="'${DBMS}' == ''"> fetch first 1 rows only </if>
	</select>
	
	<select id="getMaxEntry" parameterType="map" resultType="org.fastcatgroup.analytics.db.vo.SearchTypeRatioVO">
		select * from ${site}_${category}_${stype} where 
		timeId=(
			select max(timeId) from ${site}_${category}_${stype} where timeId like '${dFilter}%'
			<if test="dtype !=null and dtype !=''">
			and dtype=#{dtype}
			</if>
		) 
		<if test="'${DBMS}' == 'mysql'"> limit 1</if>
		<if test="'${DBMS}' == ''"> fetch first 1 rows only </if>
	</select>
	
	<select id="listTypes" parameterType="map" resultType="string">
		select distinct dtype from ${site}_${category}_${stype}
		<where>
			<if test="from != null and from != '' and to != null and to !=''">
			and timeId between #{from} and #{to}
			</if>
		</where>
	</select>
	
	<select id="getEntryListBetween" parameterType="map" resultType="org.fastcatgroup.analytics.db.vo.SearchTypeRatioVO">
		select a.* from (
		select * from ${site}_${category}_${stype}
		<where>
			<if test="dtype != null and dtype !=''">
				and dtype = #{dtype}
			</if>
			<if test="from != null and from != '' and to != null and to !=''">
				and timeId between #{from} and #{to}
			</if>
			and timeId like '${dFilter}%'
		</where>
		<if test="'${DBMS}' == 'mysql'">
			<if test="isGroup == true">
			group by dtype
			</if>
		</if>
		) a
		<if test="'${DBMS}' == ''">
			<if test="isGroup == true">
			inner join (select dtype from ${site}_${category}_${stype} group by dtype) b
			on a.dtype = b.dtype
			</if>
		</if>
	</select>
	
	<select id="getCountBetween" parameterType="map" resultType="int">
		select count(*) from ${site}_${category}_${stype} 
		<where>
			<if test="dtype != null and dtype !=''">
				and dtype = #{dtype}
			</if>
			<if test="from != null and from != '' and to != null and to !=''">
				and timeId between #{from} and #{to}
			</if>
			and timeId like '${dFilter}%'
		</where>
	</select>
	
	<select id="getSumBetween" parameterType="map" resultType="int">
		select sum(hit) from ${site}_${category}_${stype} 
		<where>
			<if test="dtype != null and dtype !=''">
			and dtype = #{dtype} 
			</if>
			and timeId between #{from} and #{to}
		</where>
	</select>
	
	<insert id="putEntry" parameterType="map" useGeneratedKeys="true" >
		insert into ${site}_${category}_${stype} 
		(timeId, dtype, hit) values (#{timeId}, #{dtype}, #{hit})
	</insert>
	
	<update id="updateEntry" parameterType="map">
		update ${site}_${category}_${stype} set hit = #{hit} 
		where timeId = #{timeId} and dtype = #{dtype}
	</update>
	
	<delete id="deleteEntry" parameterType="map">
		delete ${site}_${category}_${stype} set hit = #{hit} where timeId = #{timeId}
		and dtype = #{dtype}
	</delete>
	
	<delete id="deleteEntryBetween" parameterType="map">
		delete ${site}_${category}_${stype} set hit = #{hit}
		<where>
			<if test="dtype != null and dtype != '' ">
				and dtype=#{dtype}
			</if>
			and timeId between #{from} and #{to} 
		</where>
	</delete>
	
	<delete id="truncate" parameterType="map">
		truncate table ${site}_${category}_${stype} 
	</delete>
</mapper>